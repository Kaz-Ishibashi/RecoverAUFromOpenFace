# AU算出ロジックの検証レポート

## 1. 概要

RecoverAU.cpp (実測値と乖離が大きい実装) と OpenFace (

FaceAnalyser) のオリジナル実装を対比し、ロジックの差異と潜在的な問題点を分析しました。
## 2. 実装の対比

| 項目                      | オリジナル (FaceAnalyser.cpp)                                     | RecoverAU.cpp (現状)                     | 乖離リスク                              |
| ------------------------- | ----------------------------------------------------------------- | ---------------------------------------- | --------------------------------------- |
| **HOG特徴量のソース**     | `AlignFaceMask`で**補正(Align)された顔画像** (112x112等) から算出 | 外部ファイルから読み込み (Align済か不明) | **高** (未Align画像からのHOGなら無意味) |
| **HOGデータの並び**       | dlib抽出後、`reshape(1,1)`で平坦化 (Row-major?)                   | ファイル読み込み順 (RecorderHOG依存)     | **中** (順序不一致なら特徴量が壊れる)   |
| **Geometry特徴量**        | `[locs                                                            | local\_params]` (238次元)                | 同様の構造を再現 (修正済コードに見える) |
| **事後処理 (Clamp)**      | SVR出力後、0-5の範囲にクリップ                                    | クリップ処理なし                         | 低 (負の値が出る可能性)                 |
| **事後処理 (Correction)** | CorrectOnlineAUsでバイアス補正 (Online mode時)                    | 呼び出しなし                             | 中 (Dynamicモデル使用時は影響大)        |
| **Static/Dynamic**        | 両方計算し、用途に応じて選択                                      | `-au_static`指定だが、全出力を保存       | 低 (Staticを使う意図ならOK)             |

## 3. 詳細分析と欠落の可能性

### 3.1 HOG特徴量の整合性 (最重要)

OpenFaceのAU予測器 (SVM/SVR) は、**特定の方法で正規化（Rotation/Scale補正）された顔画像**から抽出されたHOG特徴量を入力として学習されています。

- `RecoverAU`に入力されているHOGファイルが、「OpenFaceと全く同じパラメータ (`AlignFaceMask`) で補正された顔」から抽出されたものでない場合、予測値はランダムな値や異常値になります。
- **欠けているもの**: 入力HOGの生成元となる「顔の正規化プロセス」。

### 3.2 HOGデータのメモリレイアウト

OpenFace内部では `dlib::extract_fhog_feature` を使用し、その結果を `cv::Mat` に変換しています。 

RecoverAU.cpp のコメントにあるように、入力ファイルの書き込み順序 (`y -> x -> o`) が OpenFace の期待するメモリレイアウトと一致しているか厳密な検証が必要です。ここがずれていると、空間情報が破綻します。
### 3.3 Geometryパラメータの正規化

`pdm.CalcParams` は画像座標系のランドマークを入力とします。入力CSVのランドマークが、OpenFaceが想定するスケール（ピクセル単位）である必要があります。正規化された座標（0-1など）だと誤動作します。

## 4. 改善提案

1. **入力データの検証**: HOGとランドマークが、OpenFace標準のパイプライン（`FeatureExtraction`）で出力されたものと一致するか確認する。
2. **ロジックの修正**:
    - 出力値の 0-5 クランプを追加。
    - HOG読み込み時のループ順序が OpenFace の `Extract_FHOG_descriptor` と一致しているか、コードレベルで照合。

* * *

次のステップとして、OpenFaceの `Extract_FHOG_descriptor` の実装を確認し、HOGの平坦化順序を確定させます。
